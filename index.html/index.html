<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aurelo Data — Store Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjX0JMhjY6hW+ALEwIH"
        crossorigin="anonymous" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --border:#e9ecef;
      --muted:#f7f7f9;
      --ink:#0f0f12;
      --accent:#6b46ff;
    }
    body{ background:#fff; color:var(--ink); }
    .auth{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(70% 60% at 50% 20%, #f6f6ff 0%, #ffffff 60%);
      padding:2rem;
    }
    .card-soft{ border:1px solid var(--border); border-radius:20px; background:#fff; }
    .brand{ font-weight:800; letter-spacing:.3px; display:flex; align-items:center; gap:.6rem;}
    .brand-dot{ width:10px; height:10px; border-radius:99px; background:var(--accent); display:inline-block;}
    .pill{ border:1px solid var(--border); border-radius:999px; padding:.3rem .6rem; background:#fff; font-size:.85rem; }
    .shell{ display:flex; min-height:100vh; }
    .sidebar{
      width:300px; border-right:1px solid var(--border); position:sticky; top:0; height:100vh; overflow:auto; background:#fff;
    }
    .sidebar .nav-link{ border-radius:12px; color:#111; display:flex; align-items:center; gap:.6rem; padding:.6rem .75rem; }
    .sidebar .nav-link.active{ background:#f0ecff; color:#4c2bff; border:1px solid #e7e2ff; font-weight:600; }
    .content{ flex:1; min-width:0; }
    .topbar{ border-bottom:1px solid var(--border); position:sticky; top:0; background:#fff; z-index:20; }
    .kpi{ border:1px solid var(--border); border-radius:18px; background:#fff; }
    .table-wrap{ border:1px solid var(--border); border-radius:14px; overflow:auto; }
    .btn-brand{ background:#111; color:#fff; border-radius:12px; }
    .btn-brand:hover{ background:#000; color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--border); border-radius:12px; }
    .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
           background:#f7f7f7; border:1px dashed #e5e5e5; border-radius:10px; padding:.6rem .8rem; display:block; }
    .badge-soft{ background:#f7f7ff; border:1px solid #ede9ff; color:#4c2bff; }
    @media print{
      .sidebar,.topbar,.no-print{ display:none !important; }
      .content{ padding:0!important; }
    }
  </style>
</head>
<body>

<!-- ========= LOGIN ========= -->
<section id="loginView" class="auth">
  <div class="card card-soft shadow-sm" style="max-width:520px;width:100%;">
    <div class="card-body p-4 p-md-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="brand"><span class="brand-dot"></span><span>Aurelo Data</span></div>
        <span class="pill">Store Portal</span>
      </div>
      <h1 class="h4 fw-bold mb-1">Sign in to your store</h1>
      <p class="text-secondary">Self-service analytics, AI, payouts, and operations.</p>

      <form id="loginForm" class="needs-validation" novalidate>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label">Store ID</label>
            <input class="form-control" id="storeId" placeholder="e.g., RDU-001" required />
            <div class="invalid-feedback">Enter your Store ID.</div>
          </div>
          <div class="col-12">
            <label class="form-label">Manager Username</label>
            <input class="form-control" id="userName" placeholder="you@store.com" required />
            <div class="invalid-feedback">Enter your username.</div>
          </div>
          <div class="col-12">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="userPass" placeholder="••••••••" minlength="6" required />
            <div class="invalid-feedback">Min 6 characters.</div>
          </div>
          <div class="col-12 form-check my-1">
            <input type="checkbox" class="form-check-input" id="keep" />
            <label class="form-check-label" for="keep">Keep me signed in</label>
          </div>
          <div class="col-12 d-grid mt-2">
            <button class="btn btn-brand" type="submit">Sign in</button>
          </div>
        </div>
      </form>

      <div class="mt-3 small text-secondary">
        Demo tip: any credentials will sign in locally. Example: Store <code>RDU-001</code> • User <code>monish</code>
      </div>
    </div>
  </div>
</section>

<!-- ========= APP SHELL ========= -->
<section id="appView" class="shell" style="display:none">
  <aside class="sidebar p-3">
    <div class="brand fs-5 mb-3"><span class="brand-dot"></span><span>Aurelo Store</span></div>
    <nav class="nav flex-column gap-1" id="nav">
      <a class="nav-link active" data-target="page-overview" href="#"><i class="bi bi-speedometer2"></i> Overview</a>
      <a class="nav-link" data-target="page-transactions" href="#"><i class="bi bi-table"></i> Transactions</a>
      <a class="nav-link" data-target="page-inventory" href="#"><i class="bi bi-box-seam"></i> Inventory & Restock</a>
      <a class="nav-link" data-target="page-customers" href="#"><i class="bi bi-people"></i> Customers & Loyalty</a>
      <a class="nav-link" data-target="page-promotions" href="#"><i class="bi bi-megaphone"></i> Promotions</a>
      <a class="nav-link" data-target="page-payouts" href="#"><i class="bi bi-cash-stack"></i> Payouts & Monetization</a>
      <a class="nav-link" data-target="page-dataq" href="#"><i class="bi bi-shield-check"></i> Data Quality</a>
      <a class="nav-link" data-target="page-magenta" href="#"><i class="bi bi-stars"></i> Magenta AI</a>
      <a class="nav-link" data-target="page-staff" href="#"><i class="bi bi-calendar2-week"></i> Staff Scheduling</a>
      <a class="nav-link" data-target="page-tasks" href="#"><i class="bi bi-check2-square"></i> Tasks</a>
      <a class="nav-link" data-target="page-reports" href="#"><i class="bi bi-file-earmark-bar-graph"></i> Reports</a>
      <a class="nav-link" data-target="page-settings" href="#"><i class="bi bi-gear"></i> Settings</a>
    </nav>
    <div class="mt-4">
      <div class="small text-secondary">Shortcuts</div>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <button class="btn btn-ghost btn-sm" data-target="page-inventory">Reorder</button>
        <button class="btn btn-ghost btn-sm" data-target="page-promotions">New Promo</button>
        <button class="btn btn-ghost btn-sm" data-target="page-payouts">Payouts</button>
      </div>
    </div>
    <div class="mt-4 border-top pt-3 small text-secondary">
      © Aurelo Data — Store Portal
    </div>
  </aside>

  <main class="content">
    <div class="topbar px-3 py-2">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex gap-2">
          <span class="pill">Store: <span id="tbStore">—</span></span>
          <span class="pill">Status: <span id="tbStatus">Idle</span></span>
        </div>
        <div class="dropdown">
          <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-1"></i><span id="tbUser">user</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" data-target="page-settings" href="#">Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" id="logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="pages" class="p-3 p-md-4">

      <!-- ===== OVERVIEW ===== -->
      <section id="page-overview">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Store Command Center</div>
            <div class="text-secondary">Today’s performance, AI insights, and monetization at a glance.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="ovRefresh"><i class="bi bi-arrow-repeat"></i> Refresh</button>
            <button class="btn btn-ghost btn-sm" data-target="page-reports"><i class="bi bi-printer"></i> Report</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-6 col-lg-3">
            <div class="kpi p-3">
              <div class="text-secondary small">Sales Today</div>
              <div class="h3 fw-bold" id="kpiSales">$—</div>
              <div class="small text-secondary" id="kpiSalesNote">—</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="kpi p-3">
              <div class="text-secondary small">Transactions</div>
              <div class="h3 fw-bold" id="kpiTx">—</div>
              <div class="small text-secondary">Avg basket <span id="kpiBasket">—</span></div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="kpi p-3">
              <div class="text-secondary small">Top SKU (units)</div>
              <div class="h3 fw-bold" id="kpiTopSku">—</div>
              <div class="small text-secondary" id="kpiTopSkuNote">—</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="kpi p-3">
              <div class="text-secondary small">Data Contributed</div>
              <div class="h3 fw-bold"><span id="kpiMB">—</span> MB</div>
              <div class="small text-secondary">Est. payout <span id="kpiPayout">$—</span></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12 col-lg-8">
            <div class="kpi p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">7-day Sales & Transactions</div>
                  <div class="text-secondary small">Rolling window</div>
                </div>
                <button class="btn btn-ghost btn-sm" data-target="page-transactions">Open Transactions</button>
              </div>
              <canvas id="chartSales" height="110" class="mt-2"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="kpi p-3">
              <div class="fw-bold">Top SKUs Today</div>
              <div class="text-secondary small">Units sold</div>
              <canvas id="chartTopSkus" height="110" class="mt-2"></canvas>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">AI Highlights</div>
              <ul class="mt-2" id="aiHighlights">
                <li>—</li>
              </ul>
              <div class="d-flex gap-2 no-print">
                <button class="btn btn-ghost btn-sm" data-target="page-magenta"><i class="bi bi-stars"></i> Ask Magenta AI</button>
                <button class="btn btn-ghost btn-sm" data-target="page-inventory"><i class="bi bi-box-seam"></i> Restock</button>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">Monetization Snapshot</div>
              <div class="text-secondary small">Your data → MB → $ share</div>
              <canvas id="chartMon" height="95" class="mt-2"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== TRANSACTIONS ===== -->
      <section id="page-transactions" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Transactions</div>
            <div class="text-secondary">Search, filter, and export line items.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <label class="btn btn-ghost btn-sm">
              <input type="file" id="txUpload" accept=".csv,text/csv" hidden />
              <i class="bi bi-cloud-upload"></i> Import CSV
            </label>
            <button class="btn btn-brand btn-sm" id="txExportCsv"><i class="bi bi-download"></i> Export CSV</button>
          </div>
        </div>

        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Search</label>
            <input class="form-control" id="txSearch" placeholder="SKU, basket, tender, etc." />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">From</label>
            <input type="date" class="form-control" id="txFrom" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">To</label>
            <input type="date" class="form-control" id="txTo" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">SKU</label>
            <select class="form-select" id="txSku"></select>
          </div>
          <div class="col-6 col-md-3 d-grid">
            <button class="btn btn-ghost" id="txApply">Apply</button>
          </div>
        </div>

        <div class="table-wrap mt-3">
          <table class="table table-sm table-striped table-hover mb-0" id="txTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ===== INVENTORY ===== -->
      <section id="page-inventory" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Inventory & Restock</div>
            <div class="text-secondary">Top sellers, slow movers, alerts, and reorder plan.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="invExportReorder"><i class="bi bi-download"></i> Export Reorder CSV</button>
            <button class="btn btn-ghost btn-sm" id="invSimulate"><i class="bi bi-magic"></i> Simulate Week</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-7">
            <div class="kpi p-3">
              <div class="fw-bold">SKU Performance (30 days)</div>
              <canvas id="chartSkuPerf" height="110" class="mt-2"></canvas>
            </div>
          </div>
          <div class="col-12 col-xl-5">
            <div class="kpi p-3">
              <div class="fw-bold">Restock Suggestions</div>
              <div class="text-secondary small">Based on sell-through & thresholds</div>
              <div class="table-wrap mt-2" style="max-height:260px;">
                <table class="table table-sm align-middle mb-0" id="invRestockTable">
                  <thead class="table-light"><tr><th>SKU</th><th>Stock</th><th>7d Sold</th><th>Suggest</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== CUSTOMERS ===== -->
      <section id="page-customers" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Customers & Loyalty</div>
            <div class="text-secondary">Segments, retention, and basket patterns.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="custExport"><i class="bi bi-download"></i> Export Segments</button>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-12 col-xl-4">
            <div class="kpi p-3">
              <div class="fw-bold">Segments</div>
              <ul class="mt-2" id="custSegments">
                <li>—</li>
              </ul>
            </div>
          </div>
          <div class="col-12 col-xl-4">
            <div class="kpi p-3">
              <div class="fw-bold">Retention & Visit Frequency</div>
              <canvas id="chartRetention" height="110" class="mt-2"></canvas>
            </div>
          </div>
          <div class="col-12 col-xl-4">
            <div class="kpi p-3">
              <div class="fw-bold">Basket Pairings</div>
              <div class="text-secondary small">Frequently bought together</div>
              <ul class="mt-2" id="basketPairs"><li>—</li></ul>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== PROMOTIONS ===== -->
      <section id="page-promotions" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Promotions</div>
            <div class="text-secondary">Create, simulate, and schedule store promos.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="promoSimulate"><i class="bi bi-graph-up-arrow"></i> Simulate Uplift</button>
            <button class="btn btn-brand btn-sm" id="promoAdd"><i class="bi bi-plus"></i> New Promo</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">Active & Scheduled</div>
              <div class="table-wrap mt-2">
                <table class="table table-sm align-middle mb-0" id="promoTable">
                  <thead class="table-light"><tr><th>Title</th><th>SKU(s)</th><th>Discount</th><th>Dates</th><th>Status</th><th></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">Uplift Projection</div>
              <div class="text-secondary small">Estimated sales impact from promotions</div>
              <canvas id="chartPromo" height="110" class="mt-2"></canvas>
              <div class="small mt-2">Tip: Pair high-velocity items for weekend bundles.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== PAYOUTS ===== -->
      <section id="page-payouts" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Payouts & Data Monetization</div>
            <div class="text-secondary">See MB contributions and revenue share.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="payExport"><i class="bi bi-download"></i> Export Ledger</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-5">
            <div class="kpi p-3">
              <div class="fw-bold">Summary</div>
              <ul class="mt-2">
                <li>MB this month: <strong><span id="payMbMonth">—</span></strong></li>
                <li>Est. payout: <strong id="payEst">$—</strong></li>
                <li>Next payout date: <strong id="payNext">—</strong></li>
              </ul>
              <div class="small text-secondary">Pricing assumes $/MB contract rate and store share.</div>
            </div>
          </div>
          <div class="col-12 col-xl-7">
            <div class="kpi p-3">
              <div class="fw-bold">Payout Ledger</div>
              <div class="table-wrap mt-2" style="max-height:260px;">
                <table class="table table-sm mb-0" id="payTable">
                  <thead class="table-light"><tr><th>Date</th><th>Period</th><th>MB</th><th>$</th><th>Status</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== DATA QUALITY ===== -->
      <section id="page-dataq" style="display:none">
        <div class="h5 fw-bold m-0 mb-1">Data Quality</div>
        <div class="text-secondary mb-2">File freshness, schema checks, and alerts.</div>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">Ingestion Status</div>
              <div class="table-wrap mt-2">
                <table class="table table-sm mb-0" id="dqTable">
                  <thead class="table-light"><tr><th>Time</th><th>Source</th><th>Rows</th><th>MB</th><th>Status</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="small text-secondary mt-2">Alert if no data received in 24h.</div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">Schema & Validation</div>
              <ul class="mt-2" id="dqIssues">
                <li>—</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== MAGENTA AI ===== -->
      <section id="page-magenta" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Magenta AI — Your Store Model</div>
            <div class="text-secondary">Ask natural questions. See forecasts & recommendations.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="aiRetrain"><i class="bi bi-rocket-takeoff"></i> Retrain (demo)</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <label class="form-label">Ask a question</label>
              <textarea class="form-control" id="aiQ" rows="4" placeholder="Which SKUs will stock out by Friday?"></textarea>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-brand" id="aiAsk"><i class="bi bi-stars"></i> Ask</button>
                <button class="btn btn-ghost" id="aiClear">Clear</button>
              </div>
              <div class="mt-3">
                <div class="fw-bold">Answer</div>
                <pre class="code" id="aiA" style="min-height:140px">—</pre>
                <div class="row g-2 mt-1">
                  <div class="col"><div class="kpi p-2 text-center"><div class="text-secondary small">Latency (ms)</div><div class="h6 m-0" id="aiLat">—</div></div></div>
                  <div class="col"><div class="kpi p-2 text-center"><div class="text-secondary small">Token Est.</div><div class="h6 m-0" id="aiTok">—</div></div></div>
                  <div class="col"><div class="kpi p-2 text-center"><div class="text-secondary small">Route</div><div class="h6 m-0" id="aiRoute">—</div></div></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="kpi p-3">
              <div class="fw-bold">7-day Forecast</div>
              <canvas id="chartForecast" height="110" class="mt-2"></canvas>
              <div class="fw-bold mt-3">Recommendations</div>
              <ul id="aiRecs" class="mt-2">
                <li>—</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== STAFF ===== -->
      <section id="page-staff" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Staff Scheduling</div>
            <div class="text-secondary">Plan shifts based on sales patterns.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-ghost btn-sm" id="staffSuggest"><i class="bi bi-lightning"></i> Suggest Staffing</button>
            <button class="btn btn-ghost btn-sm" id="staffExport"><i class="bi bi-download"></i> Export</button>
          </div>
        </div>

        <div class="kpi p-3">
          <div class="table-wrap">
            <table class="table table-sm align-middle mb-0" id="staffTable">
              <thead class="table-light"><tr><th>Day</th><th>Open</th><th>Close</th><th>Staff Needed (peak)</th><th>Notes</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== TASKS ===== -->
      <section id="page-tasks" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Tasks</div>
            <div class="text-secondary">Daily operations and reminders.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-brand btn-sm" id="taskAdd"><i class="bi bi-plus"></i> Add Task</button>
          </div>
        </div>

        <div class="kpi p-3">
          <div class="table-wrap">
            <table class="table table-sm mb-0" id="taskTable">
              <thead class="table-light"><tr><th>Task</th><th>Priority</th><th>Due</th><th>Status</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== REPORTS ===== -->
      <section id="page-reports" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="h5 fw-bold m-0">Reports</div>
            <div class="text-secondary">Print-ready weekly digest & KPI export.</div>
          </div>
          <div class="d-flex gap-2 no-print">
            <button class="btn btn-brand btn-sm" onclick="window.print()"><i class="bi bi-printer"></i> Print / Save PDF</button>
            <button class="btn btn-ghost btn-sm" id="repExportJson"><i class="bi bi-download"></i> Export KPIs JSON</button>
          </div>
        </div>

        <div class="kpi p-3">
          <h5 class="fw-bold">Aurelo Store — Weekly Summary</h5>
          <p class="mb-2">Snapshot of sales, transactions, top SKUs, and data monetization.</p>
          <hr/>
          <div class="row g-3">
            <div class="col-md"><div class="kpi p-2 text-center"><div class="text-secondary small">7d Sales Avg</div><div class="h5 m-0" id="repSalesAvg">$—</div></div></div>
            <div class="col-md"><div class="kpi p-2 text-center"><div class="text-secondary small">7d Tx Avg</div><div class="h5 m-0" id="repTxAvg">—</div></div></div>
            <div class="col-md"><div class="kpi p-2 text-center"><div class="text-secondary small">Top SKU</div><div class="h5 m-0" id="repTopSku">—</div></div></div>
            <div class="col-md"><div class="kpi p-2 text-center"><div class="text-secondary small">MB → $ (est.)</div><div class="h5 m-0" id="repPayout">$—</div></div></div>
          </div>
          <div class="mt-3">
            <div class="fw-bold">Notes</div>
            <ul id="repNotes">
              <li>Data derived from local demo; connect POS for live metrics.</li>
              <li>Magenta AI provides store-specific forecasts & actions.</li>
              <li>Promotions can be scheduled ahead of peak periods.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- ===== SETTINGS ===== -->
      <section id="page-settings" style="display:none">
        <div class="h5 fw-bold m-0 mb-1">Settings</div>
        <div class="text-secondary mb-2">Store profile, POS, theme, and session.</div>

        <div class="kpi p-3">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Theme</label>
              <select id="theme" class="form-select">
                <option value="light" selected>Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">POS Integration Key</label>
              <input class="form-control" id="posKey" placeholder="••••••••••• (demo only)" />
            </div>
            <div class="col-md-4 d-grid align-items-end">
              <button class="btn btn-brand mt-md-4" id="applySettings">Apply</button>
            </div>
          </div>
          <hr/>
          <div class="d-flex gap-2">
            <button class="btn btn-ghost" id="resetApp">Reset Local Demo</button>
            <button class="btn btn-danger" id="logout2">Logout</button>
          </div>
        </div>
      </section>

    </div>
  </main>
</section>

<!-- ========= SCRIPTS ========= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
(() => {
  // ========== Helpers ==========
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
  const nf = new Intl.NumberFormat('en-US');
  const money = v => '$' + nf.format(Math.round(v));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const rand = (a,b)=> a + Math.random()*(b-a);
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  const setStatus = t => $('#tbStatus').innerText = t;

  function download(name, text, mime='text/plain;charset=utf-8'){
    const blob = new Blob([text], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }
  function toCSV(rows){
    if(!rows?.length) return '';
    const cols = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
    return [cols.map(esc).join(','), ...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n');
  }

  // ========== Demo Data Model ==========
  const DEMO_SKUS = ['APPLE','BREAD','MILK','EGGS','RICE','SODA','BANANA','CHIPS','PASTA','COFFEE'];
  const UNIT_PRICE = {APPLE:1.49,BREAD:2.99,MILK:3.59,EGGS:2.79,RICE:6.49,SODA:1.29,BANANA:0.59,CHIPS:2.49,PASTA:1.99,COFFEE:9.99};
  const KB_PER_TX = 3.0;             // approx per transaction data footprint
  const USD_PER_MB = 50;             // illustrative contract pricing
  const STORE_SHARE = 0.36;          // store share of payout

  // one "transaction" = one basket (with multiple line items)
  function genDemoData(days=30, avgTxPerDay=220){
    const transactions = [];
    const lineItems = []; // flattened rows
    const inventory  = {}; DEMO_SKUS.forEach(s=> inventory[s] = {sku:s, stock: Math.floor(rand(120,260)), reorder_threshold: 40});
    const customers  = []; // id, visits
    const basketsByDay = [];
    let custId = 1000;

    const start = new Date();
    start.setDate(start.getDate()-days+1);

    for(let d=0; d<days; d++){
      const date = new Date(start.getTime() + d*86400000);
      const ymd  = date.toISOString().slice(0,10);
      const dayCount = Math.round(rand(avgTxPerDay*0.85, avgTxPerDay*1.15));
      const dayBaskets = [];
      for(let t=0;t<dayCount;t++){
        const id = `${ymd}-${t+1}`;
        const nItems = Math.max(1, Math.round(rand(2,5)));
        const items=[];
        for(let k=0;k<nItems;k++){
          const sku = pick(DEMO_SKUS);
          const qty = Math.max(1, Math.round(rand(1,3)));
          items.push({sku, qty, price: UNIT_PRICE[sku]});
          // update inventory sold
          inventory[sku].stock = Math.max(0, inventory[sku].stock - qty);
        }
        const subtotal = items.reduce((s,i)=> s + i.qty*i.price, 0);
        const tax = subtotal*0.07, total = subtotal+tax;
        const cust = Math.random()<0.6 ? pick(customers) : (customers.push({id:custId++, visits:0, seg: pick(['Family','Student','Professional','Senior'])}), customers.at(-1));
        cust.visits++;

        const tx = { id, date: ymd, time: `${String(Math.floor(rand(8,21))).padStart(2,'0')}:${String(Math.floor(rand(0,60))).padStart(2,'0')}`, items, subtotal:+subtotal.toFixed(2), tax:+tax.toFixed(2), total:+total.toFixed(2), tender: pick(['CASH','CARD','WALLET']), basket_id:id, customer_id:cust.id };
        transactions.push(tx);
        dayBaskets.push(tx);

        // flatten line items
        items.forEach(it=>{
          lineItems.push({
            transaction_id: id,
            basket_id: id,
            date: ymd,
            time: tx.time,
            sku: it.sku,
            qty: it.qty,
            price: it.price.toFixed(2),
            line_total: (it.qty*it.price).toFixed(2),
            tender: tx.tender,
            store_id: 'RDU-001'
          });
        });
      }
      basketsByDay.push({date: ymd, baskets: dayBaskets});
    }
    return {transactions, lineItems, inventory, customers, basketsByDay};
  }

  // Persistent state (local demo)
  let storeState = JSON.parse(localStorage.getItem('aurelo_store_demo')||'null');
  if(!storeState){
    storeState = genDemoData(30, 220);
    localStorage.setItem('aurelo_store_demo', JSON.stringify(storeState));
  }

  // ========== Auth ==========
  const loginView = $('#loginView'), appView = $('#appView');
  function showApp(){
    loginView.style.display='none'; appView.style.display='flex';
    $('#tbStore').innerText = localStorage.getItem('store_id')||'RDU-001';
    $('#tbUser').innerText  = localStorage.getItem('user_name')||'user';
    route('page-overview');
    renderAll();
  }
  function showLogin(){ loginView.style.display='flex'; appView.style.display='none'; }

  const authed = localStorage.getItem('keep')==='1' && localStorage.getItem('authed')==='1';
  if(authed) showApp();

  $('#loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const f=e.currentTarget;
    if(!f.checkValidity()){ f.classList.add('was-validated'); return; }
    localStorage.setItem('store_id', $('#storeId').value.trim()||'RDU-001');
    localStorage.setItem('user_name', $('#userName').value.trim()||'user');
    localStorage.setItem('authed','1');
    localStorage.setItem('keep', $('#keep').checked ? '1':'0');
    showApp();
  });
  $('#logout, #logout2').addEventListener('click', (e)=>{
    e.preventDefault();
    localStorage.removeItem('authed');
    if(localStorage.getItem('keep')!=='1'){
      localStorage.removeItem('user_name'); localStorage.removeItem('store_id');
    }
    showLogin();
  });

  // ========== Router ==========
  function route(id){
    $$('#nav .nav-link').forEach(a=> a.classList.toggle('active', a.dataset.target===id));
    $$('#pages > section').forEach(s=> s.style.display = (s.id===id) ? '' : 'none');
    setStatus('Idle');
  }
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-target]'); if(!t) return;
    e.preventDefault(); route(t.dataset.target);
  });

  // ========== Overview ==========
  let chSales, chTopSkus, chMon;
  function computeToday(){
    const d = todayISO();
    const todays = storeState.transactions.filter(t=> t.date===d);
    const tx = todays.length;
    const sales = todays.reduce((s,t)=> s+t.total, 0);
    const items = todays.flatMap(t=> t.items);
    const bySku = {};
    items.forEach(i=> bySku[i.sku]=(bySku[i.sku]||0)+i.qty);
    const top = Object.entries(bySku).sort((a,b)=>b[1]-a[1])[0] || ['—',0];
    const basketAvg = tx ? (sales/tx) : 0;
    const mb = (tx*KB_PER_TX/1024);
    const estPayout = mb*USD_PER_MB*STORE_SHARE;

    return {
      tx, sales, basketAvg, topSku: top[0], topUnits: top[1],
      mb: +mb.toFixed(1), payout: Math.round(estPayout)
    };
  }
  function series7d(){
    const last7 = storeState.basketsByDay.slice(-7);
    const labels = last7.map(d=>d.date.slice(5));
    const sales  = last7.map(d=> Math.round(d.baskets.reduce((s,t)=>s+t.total,0)));
    const txs    = last7.map(d=> d.baskets.length);
    return {labels, sales, txs};
  }
  function topSkusToday(){
    const d=todayISO();
    const rows = storeState.transactions.filter(t=>t.date===d).flatMap(t=>t.items);
    const agg = {};
    rows.forEach(r=> agg[r.sku]=(agg[r.sku]||0)+r.qty);
    const pairs = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,5);
    return {labels:pairs.map(p=>p[0]), units:pairs.map(p=>p[1])};
  }
  function renderOverview(){
    const t = computeToday();
    $('#kpiSales').innerText = money(t.sales);
    $('#kpiSalesNote').innerText = 'vs avg ' + money(avgLast7().sales);
    $('#kpiTx').innerText = nf.format(t.tx);
    $('#kpiBasket').innerText = money(t.basketAvg);
    $('#kpiTopSku').innerText = t.topSku;
    $('#kpiTopSkuNote').innerText = nf.format(t.topUnits) + ' units';
    $('#kpiMB').innerText = t.mb;
    $('#kpiPayout').innerText = money(t.payout);

    const s = series7d();
    chSales?.destroy();
    chSales = new Chart($('#chartSales'), {
      type:'line',
      data:{ labels:s.labels, datasets:[
        {label:'Sales ($)', data:s.sales, tension:.35},
        {label:'Transactions', data:s.txs, tension:.35}
      ]},
      options:{ plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}} }
    });

    const ts = topSkusToday();
    chTopSkus?.destroy();
    chTopSkus = new Chart($('#chartTopSkus'), {
      type:'bar',
      data:{ labels: ts.labels, datasets:[{label:'Units', data: ts.units}]},
      options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });

    chMon?.destroy();
    chMon = new Chart($('#chartMon'), {
      type:'doughnut',
      data:{ labels:['Store Share','Aurelo Share'], datasets:[{data:[Math.round(t.payout), Math.round(t.payout/STORE_SHARE - t.payout)}]} },
      options:{ plugins:{legend:{position:'bottom'}} }
    });

    // AI highlights
    const hl = $('#aiHighlights'); hl.innerHTML='';
    [
      `Peak hour forecast today: ${pick(['12:00-13:00','17:00-18:00','18:00-19:00'])}`,
      `Restock soon: ${pick(DEMO_SKUS)} & ${pick(DEMO_SKUS)} (below threshold)`,
      `Bundle idea: ${pick(['BREAD + BUTTER','COFFEE + PASTRY','MILK + CEREAL'])}`
    ].forEach(t=>{ const li=document.createElement('li'); li.textContent=t; hl.appendChild(li); });
  }
  function avgLast7(){
    const s = series7d();
    const avgSales = Math.round(s.sales.reduce((a,b)=>a+b,0)/s.sales.length);
    const avgTx    = Math.round(s.txs.reduce((a,b)=>a+b,0)/s.txs.length);
    return {sales:avgSales, tx:avgTx};
  }
  $('#ovRefresh').addEventListener('click', renderOverview);

  // ========== Transactions ==========
  function renderTxTable(rows){
    const thead = $('#txTable thead'), tbody = $('#txTable tbody');
    thead.innerHTML=''; tbody.innerHTML='';
    if(!rows.length){ thead.innerHTML='<tr><th>No data</th></tr>'; return; }
    const cols = Object.keys(rows[0]);
    const trh = document.createElement('tr');
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
    thead.appendChild(trh);
    rows.slice(0,5000).forEach(r=>{
      const tr=document.createElement('tr');
      cols.forEach(c=>{ const td=document.createElement('td'); td.textContent=r[c]; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
  }
  function seedTxFilters(){
    const sel = $('#txSku'); sel.innerHTML='<option value="">All</option>';
    DEMO_SKUS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  }
  function applyTxFilters(){
    const q = $('#txSearch').value.trim().toLowerCase();
    const from = $('#txFrom').value, to = $('#txTo').value, sku = $('#txSku').value;
    let rows = storeState.lineItems;
    if(from) rows = rows.filter(r=> r.date >= from);
    if(to) rows = rows.filter(r=> r.date <= to);
    if(sku) rows = rows.filter(r=> r.sku === sku);
    if(q) rows = rows.filter(r=> Object.values(r).some(v=> String(v).toLowerCase().includes(q)));
    renderTxTable(rows);
  }
  $('#txApply').addEventListener('click', applyTxFilters);
  $('#txSearch').addEventListener('input', applyTxFilters);
  $('#txExportCsv').addEventListener('click', ()=>{
    download('store_transactions.csv', toCSV(storeState.lineItems), 'text/csv');
  });
  $('#txUpload').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return;
    setStatus('Parsing CSV');
    Papa.parse(f, {
      header:true, skipEmptyLines:true,
      complete: (res)=>{
        // Merge naive: append to lineItems
        storeState.lineItems = res.data.concat(storeState.lineItems);
        localStorage.setItem('aurelo_store_demo', JSON.stringify(storeState));
        applyTxFilters();
        setStatus('Idle');
        alert('Imported ' + res.data.length + ' rows.');
      }
    });
  });

  // ========== Inventory ==========
  let chSkuPerf;
  function skuPerf30d(){
    const map = {}; DEMO_SKUS.forEach(s=> map[s]=0);
    storeState.transactions.forEach(t=>{
      t.items.forEach(it=> map[it.sku]+=it.qty);
    });
    const pairs = Object.entries(map).sort((a,b)=> b[1]-a[1]);
    return {labels: pairs.map(p=>p[0]), units: pairs.map(p=>p[1])};
  }
  function renderInventory(){
    const perf = skuPerf30d();
    chSkuPerf?.destroy();
    chSkuPerf = new Chart($('#chartSkuPerf'), {
      type:'bar',
      data:{ labels: perf.labels, datasets:[{label:'Units (30d)', data: perf.units}]},
      options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });

    // Restock table
    const tb=$('#invRestockTable tbody'); tb.innerHTML='';
    const last7 = storeState.transactions.slice(-Math.min(7*200, storeState.transactions.length));
    const last7Sold = {}; DEMO_SKUS.forEach(s=> last7Sold[s]=0);
    last7.forEach(t=> t.items.forEach(it=> last7Sold[it.sku]+=it.qty));
    DEMO_SKUS.forEach(sku=>{
      const s=storeState.inventory[sku];
      const suggest = Math.max(0, (last7Sold[sku]*2) - s.stock, s.reorder_threshold*2 - s.stock);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${sku}</td>
        <td>${s.stock}</td>
        <td>${last7Sold[sku]}</td>
        <td><input class="form-control form-control-sm" type="number" min="0" value="${Math.max(0, Math.round(suggest))}"/></td>
        <td class="text-end"><button class="btn btn-sm btn-outline-primary">Order</button></td>
      `;
      tr.querySelector('button').addEventListener('click', ()=>{
        const qty = Number(tr.querySelector('input').value)||0;
        if(qty<=0) return;
        s.stock += qty;
        alert(`Placed reorder for ${qty} units of ${sku}.`);
        renderInventory();
      });
      tb.appendChild(tr);
    });
  }
  $('#invSimulate').addEventListener('click', ()=>{
    // simulate a week of sales reducing stock
    DEMO_SKUS.forEach(s=>{
      storeState.inventory[s].stock = Math.max(0, storeState.inventory[s].stock - Math.round(rand(10,70)));
    });
    localStorage.setItem('aurelo_store_demo', JSON.stringify(storeState));
    renderInventory();
  });
  $('#invExportReorder').addEventListener('click', ()=>{
    const rows=[];
    $$('#invRestockTable tbody tr').forEach(tr=>{
      const sku=tr.children[0].innerText;
      const qty=tr.querySelector('input').value;
      rows.push({sku, reorder_qty: qty});
    });
    download('reorder_plan.csv', toCSV(rows), 'text/csv');
  });

  // ========== Customers ==========
  let chRetention;
  function renderCustomers(){
    // segments
    const segs = storeState.customers.reduce((m,c)=> (m[c.seg]=(m[c.seg]||0)+1, m), {});
    const ul = $('#custSegments'); ul.innerHTML='';
    Object.entries(segs).forEach(([k,v])=>{
      const li=document.createElement('li'); li.innerHTML = `<span class="badge badge-soft me-2">${k}</span> ${v} customers`;
      ul.appendChild(li);
    });

    // visit frequency buckets
    const buckets = { '1-2':0, '3-5':0, '6-10':0, '11+':0 };
    storeState.customers.forEach(c=>{
      const v=c.visits;
      if(v<=2) buckets['1-2']++; else if(v<=5) buckets['3-5']++; else if(v<=10) buckets['6-10']++; else buckets['11+']++;
    });
    chRetention?.destroy();
    chRetention = new Chart($('#chartRetention'), {
      type:'bar',
      data:{ labels:Object.keys(buckets), datasets:[{label:'Customers', data:Object.values(buckets)}]},
      options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });

    // basket pairs (simple random showcase from DEMO)
    const pairsUL = $('#basketPairs'); pairsUL.innerHTML='';
    const pairIdeas = ['BREAD + BUTTER','MILK + CEREAL','COFFEE + PASTRY','CHIPS + SODA','PASTA + SAUCE','EGGS + BACON'];
    pairIdeas.slice(0,5).forEach(p=>{
      const li=document.createElement('li'); li.textContent=p; pairsUL.appendChild(li);
    });
  }
  $('#custExport').addEventListener('click', ()=>{
    const segs = storeState.customers.map(c=> ({customer_id:c.id, segment:c.seg, visits:c.visits}));
    download('customer_segments.csv', toCSV(segs), 'text/csv');
  });

  // ========== Promotions ==========
  let chPromo;
  let promos = JSON.parse(localStorage.getItem('store_promos')||'[]');
  function renderPromos(){
    const tb = $('#promoTable tbody'); tb.innerHTML='';
    promos.forEach((p,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control form-control-sm" value="${p.title}"/></td>
        <td><input class="form-control form-control-sm" value="${p.skus}"/></td>
        <td><input class="form-control form-control-sm" value="${p.discount}"/></td>
        <td><input class="form-control form-control-sm" value="${p.dates}"/></td>
        <td>
          <select class="form-select form-select-sm">
            <option ${p.status==='Scheduled'?'selected':''}>Scheduled</option>
            <option ${p.status==='Active'?'selected':''}>Active</option>
            <option ${p.status==='Paused'?'selected':''}>Paused</option>
            <option ${p.status==='Ended'?'selected':''}>Ended</option>
          </select>
        </td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-del="${idx}"><i class="bi bi-trash"></i></button></td>
      `;
      tb.appendChild(tr);
    });
  }
  function savePromos(){
    // read back
    const rows = $$('#promoTable tbody tr').map(tr=>{
      return {
        title:  tr.children[0].querySelector('input').value,
        skus:   tr.children[1].querySelector('input').value,
        discount: tr.children[2].querySelector('input').value,
        dates:  tr.children[3].querySelector('input').value,
        status: tr.children[4].querySelector('select').value
      };
    });
    promos = rows; localStorage.setItem('store_promos', JSON.stringify(promos));
  }
  $('#promoAdd').addEventListener('click', ()=>{
    promos.unshift({title:'Weekend Bundle', skus:'COFFEE,PASTRY', discount:'-10%', dates:'Fri-Sun', status:'Scheduled'});
    localStorage.setItem('store_promos', JSON.stringify(promos));
    renderPromos();
  });
  $('#promoTable').addEventListener('input', savePromos);
  $('#promoTable').addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del]'); if(!del) return;
    const idx = +del.dataset.del; promos.splice(idx,1);
    localStorage.setItem('store_promos', JSON.stringify(promos)); renderPromos();
  });
  $('#promoSimulate').addEventListener('click', ()=>{
    const labels=['Base','With Promo'];
    const base = Math.round(rand(8000,10000));
    const uplift = Math.round(base*rand(0.05, 0.18));
    chPromo?.destroy();
    chPromo = new Chart($('#chartPromo'), {
      type:'bar',
      data:{ labels, datasets:[{label:'Projected Sales ($)', data:[base, base+uplift]}]},
      options:{ plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}} }
    });
    alert('Simulated uplift ' + money(uplift) + ' for current promos.');
  });

  // ========== Payouts ==========
  function renderPayouts(){
    const monthTx = storeState.transactions.filter(t=> t.date.slice(0,7)=== new Date().toISOString().slice(0,7));
    const mbMonth = (monthTx.length * KB_PER_TX / 1024).toFixed(1);
    const est = Math.round(mbMonth * USD_PER_MB * STORE_SHARE);
    $('#payMbMonth').innerText = mbMonth;
    $('#payEst').innerText = money(est);
    const next = new Date(); next.setDate(28); $('#payNext').innerText = next.toISOString().slice(0,10);

    const tb=$('#payTable tbody'); tb.innerHTML='';
    const ledger = [];
    for(let m=5;m>=0;m--){
      const dt = new Date(); dt.setMonth(dt.getMonth()-m, 28);
      const label = dt.toLocaleString('en-US',{month:'short', year:'numeric'});
      const mb = Math.round(rand(280, 520)*10)/10;
      const val = Math.round(mb * USD_PER_MB * STORE_SHARE);
      ledger.push({date: dt.toISOString().slice(0,10), period: label, mb, usd: val, status: m? 'Paid':'Pending'});
    }
    ledger.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.date}</td><td>${r.period}</td><td>${r.mb}</td><td>${money(r.usd)}</td><td>${r.status}</td>`;
      tb.appendChild(tr);
    });
  }
  $('#payExport').addEventListener('click', ()=>{
    const rows=[]; $$('#payTable tbody tr').forEach(tr=>{
      rows.push({date: tr.children[0].innerText, period: tr.children[1].innerText, mb: tr.children[2].innerText, usd: tr.children[3].innerText, status: tr.children[4].innerText});
    });
    download('payout_ledger.csv', toCSV(rows), 'text/csv');
  });

  // ========== Data Quality ==========
  function renderDataQ(){
    const tb=$('#dqTable tbody'); tb.innerHTML='';
    // synthesize recent 5 ingestions
    const rows = [];
    for(let i=0;i<5;i++){
      const dt=new Date(Date.now()-i*6*3600*1000);
      rows.push({time: dt.toISOString().replace('T',' ').slice(0,19), source: pick(['POS','S3','Ecom','Partner API']), r: Math.round(rand(400,900)), mb: (Math.round(rand(1.2,3.2)*10)/10).toFixed(1), status: 'OK'});
    }
    rows[1].status = 'Warning'; // spice
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.time}</td><td>${r.source}</td><td>${r.r}</td><td>${r.mb}</td><td><span class="badge ${r.status==='OK'?'text-bg-success':'text-bg-warning'}">${r.status}</span></td>`;
      tb.appendChild(tr);
    });

    const ul=$('#dqIssues'); ul.innerHTML='';
    [
      'Schema: transaction_id, basket_id, date, time, sku, qty, price, tender ✔',
      'No duplicate keys detected ✔',
      'Warning: 1 file missing optional column "cashier_id"'
    ].forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }

  // ========== Magenta AI ==========
  let chForecast;
  function renderForecast(){
    const labels = ['D1','D2','D3','D4','D5','D6','D7'];
    const last = series7d().sales.at(-1);
    const base = last/1.1;
    const data = labels.map((_,i)=> Math.round(base * (1 + 0.02*i + (Math.random()-0.5)*0.04)));
    chForecast?.destroy();
    chForecast = new Chart($('#chartForecast'), {
      type:'line',
      data:{ labels, datasets:[{label:'Projected Sales ($)', data, tension:.35}]},
      options:{ plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:false}} }
    });
  }
  function aiAnswer(q){
    q = q.toLowerCase();
    const ans = [];
    if(/top.*sku/.test(q) || /best.*seller/.test(q)){
      const top = skuPerf30d().labels[0];
      ans.push(`Top SKU (30d): ${top}.`);
    }
    if(/stock.*out|restock|re.?order/.test(q)){
      const risky = DEMO_SKUS.filter(s=> storeState.inventory[s].stock < storeState.inventory[s].reorder_threshold).slice(0,3);
      ans.push(`Likely to stock out soon: ${risky.join(', ') || 'none'} (consider reorder).`);
    }
    if(/payout|mb|moneti/.test(q)){
      const t=computeToday(); ans.push(`Estimated daily MB: ${t.mb} MB; Estimated payout today: ${money(t.payout)}.`);
    }
    if(/forecast|sell|next/.test(q)){
      ans.push('Sales expected to peak between 5–7 PM; weekend uplift +8–12% vs weekdays.');
    }
    if(!ans.length) ans.push('I analyzed recent data and recommend: boost COFFEE + PASTRY in morning; restock MILK before Friday; schedule 1 extra cashier 5–7 PM.');
    return ans.join('\n');
  }
  $('#aiAsk').addEventListener('click', ()=>{
    const q = $('#aiQ').value.trim(); if(!q) return alert('Ask a question.');
    setStatus('Routing');
    const lat = Math.round(rand(120, 280));
    const tok = Math.round(rand(80, 220));
    const route = pick(['US-East','US-West']);
    setTimeout(()=>{
      $('#aiA').textContent = aiAnswer(q);
      $('#aiLat').innerText = lat;
      $('#aiTok').innerText = tok;
      $('#aiRoute').innerText = route;
      setStatus('Idle');
    }, 420);
  });
  $('#aiClear').addEventListener('click', ()=>{
    $('#aiQ').value=''; $('#aiA').textContent='—'; $('#aiLat').innerText='—'; $('#aiTok').innerText='—'; $('#aiRoute').innerText='—';
  });
  $('#aiRetrain').addEventListener('click', ()=> alert('Demo: model retraining queued for overnight window.'));

  function renderAIRecs(){
    const ul=$('#aiRecs'); ul.innerHTML='';
    [
      'Reorder EGGS (stock < threshold; 7d velocity up 12%).',
      'Bundle COFFEE + PASTRY 7–10 AM; expected +10% uplift.',
      'Schedule extra cashier 17:00–19:00 (peak).'
    ].forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
  }

  // ========== Staff ==========
  function renderStaff(){
    const tb=$('#staffTable tbody'); tb.innerHTML='';
    const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    days.forEach(d=>{
      const open='08:00', close='21:00', peak=Math.round(rand(3,6));
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d}</td>
        <td><input class="form-control form-control-sm" value="${open}"/></td>
        <td><input class="form-control form-control-sm" value="${close}"/></td>
        <td><input class="form-control form-control-sm" type="number" min="1" value="${peak}"/></td>
        <td><input class="form-control form-control-sm" placeholder="Notes"/></td>
      `;
      tb.appendChild(tr);
    });
  }
  $('#staffSuggest').addEventListener('click', ()=>{
    $$('#staffTable tbody tr').forEach(tr=>{
      // bump peak on Fri/Sat
      const day=tr.children[0].innerText;
      const input=tr.children[3].querySelector('input');
      let v=Number(input.value)||3;
      if(['Fri','Sat'].includes(day)) v = Math.max(v, v+1);
      input.value = v;
    });
    alert('Suggested staffing applied based on peak hours.');
  });
  $('#staffExport').addEventListener('click', ()=>{
    const rows=[]; $$('#staffTable tbody tr').forEach(tr=>{
      rows.push({day:tr.children[0].innerText, open: tr.children[1].querySelector('input').value, close: tr.children[2].querySelector('input').value, staff_peak: tr.children[3].querySelector('input').value, notes: tr.children[4].querySelector('input').value});
    });
    download('staff_schedule.csv', toCSV(rows), 'text/csv');
  });

  // ========== Tasks ==========
  let tasks = JSON.parse(localStorage.getItem('store_tasks')||'[]');
  function renderTasks(){
    const tb=$('#taskTable tbody'); tb.innerHTML='';
    tasks.forEach((t,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input class="form-control form-control-sm" value="${t.title}"/></td>
        <td>
          <select class="form-select form-select-sm">
            <option ${t.priority==='Low'?'selected':''}>Low</option>
            <option ${t.priority==='Medium'?'selected':''}>Medium</option>
            <option ${t.priority==='High'?'selected':''}>High</option>
          </select>
        </td>
        <td><input class="form-control form-control-sm" type="date" value="${t.due||''}"/></td>
        <td>
          <select class="form-select form-select-sm">
            <option ${t.status==='Open'?'selected':''}>Open</option>
            <option ${t.status==='In Progress'?'selected':''}>In Progress</option>
            <option ${t.status==='Done'?'selected':''}>Done</option>
          </select>
        </td>
        <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-del="${idx}"><i class="bi bi-trash"></i></button></td>
      `;
      tb.appendChild(tr);
    });
  }
  function saveTasks(){
    const rows = $$('#taskTable tbody tr').map(tr=>{
      return {
        title: tr.children[0].querySelector('input').value,
        priority: tr.children[1].querySelector('select').value,
        due: tr.children[2].querySelector('input').value,
        status: tr.children[3].querySelector('select').value
      };
    });
    tasks = rows; localStorage.setItem('store_tasks', JSON.stringify(tasks));
  }
  $('#taskAdd').addEventListener('click', ()=>{
    tasks.unshift({title:'Front shelf reset', priority:'Medium', due: todayISO(), status:'Open'});
    localStorage.setItem('store_tasks', JSON.stringify(tasks));
    renderTasks();
  });
  $('#taskTable').addEventListener('input', saveTasks);
  $('#taskTable').addEventListener('click', (e)=>{
    const del=e.target.closest('[data-del]'); if(!del) return;
    tasks.splice(+del.dataset.del,1); localStorage.setItem('store_tasks', JSON.stringify(tasks)); renderTasks();
  });

  // ========== Reports ==========
  $('#repExportJson').addEventListener('click', ()=>{
    const t=computeToday(), a=avgLast7();
    const json = {
      generated_at: new Date().toISOString(),
      store: localStorage.getItem('store_id')||'RDU-001',
      today: { sales: t.sales, tx: t.tx, top_sku: t.topSku, mb: t.mb, payout: t.payout },
      avg7d: a,
    };
    download('store_kpis.json', JSON.stringify(json, null, 2));
  });
  function renderReportTiles(){
    const t=computeToday(), a=avgLast7();
    $('#repSalesAvg').innerText = money(a.sales);
    $('#repTxAvg').innerText    = nf.format(a.tx);
    $('#repTopSku').innerText   = t.topSku;
    $('#repPayout').innerText   = money(t.payout);
  }

  // ========== Settings ==========
  function applyTheme(mode){
    if(mode==='dark'){
      document.body.style.background='#0f0f12';
      document.body.style.color='#f1f3f5';
      $$('.kpi').forEach(c=>{ c.style.background='#141418'; c.style.borderColor='#2a2a30'; });
      $$('.sidebar,.topbar').forEach(c=>{ c.style.background='#101016'; c.style.borderColor='#2a2a30'; });
    } else {
      document.body.style.background='#fff';
      document.body.style.color='#0f0f12';
      $$('.kpi').forEach(c=>{ c.style.background='#fff'; c.style.borderColor='#e9ecef'; });
      $$('.sidebar,.topbar').forEach(c=>{ c.style.background='#fff'; c.style.borderColor='#e9ecef'; });
    }
  }
  $('#applySettings').addEventListener('click', ()=>{
    const t = $('#theme').value; localStorage.setItem('theme', t); applyTheme(t); alert('Settings applied.');
  });
  $('#resetApp').addEventListener('click', ()=>{
    if(!confirm('Reset local demo data?')) return;
    localStorage.removeItem('aurelo_store_demo');
    localStorage.removeItem('store_promos');
    localStorage.removeItem('store_tasks');
    location.reload();
  });

  // ========== Render All ==========
  function renderAll(){
    renderOverview();
    seedTxFilters(); applyTxFilters();
    renderInventory();
    renderCustomers();
    renderPromos();
    renderPayouts();
    renderDataQ();
    renderForecast(); renderAIRecs();
    renderStaff();
    renderTasks();
    renderReportTiles();
    const savedTheme = localStorage.getItem('theme')||'light';
    $('#theme').value = savedTheme; applyTheme(savedTheme);
  }

  // initial mount if authed
  // (if not authed, render happens after sign-in)
})();
</script>
</body>
</html>
